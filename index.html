<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KinoBot Web App</title>
  <link rel="icon" href="https://example.com/my-favicon.ico">
  <link rel="stylesheet" href="style.css?v=50" />
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #111;
      color: #fff;
    }
    .section {
      display: none;
      padding: 20px;
    }
    .active {
      display: block;
    }
    .nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      display: flex;
      justify-content: space-around;
      padding: 10px 0 6px;
      border-top: 1px solid #333;
      z-index: 999;
      box-shadow: 0 -2px 10px rgba(0, 255, 255, 0.15);
    }
    .nav button {
      background: none;
      border: none;
      color: #aaa;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 10px;
      transition: all 0.2s ease-in-out;
      position: relative;
    }
    .nav button span {
      margin-top: 4px;
      font-size: 14px;
    }
    .nav button.active {
      color: #00f7ff;
      text-shadow: 0 0 6px #00f7ff;
      transform: scale(1.1);
    }
    .nav button.active::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 50%;
      transform: translateX(-50%);
      width: 36%;
      height: 3px;
      border-radius: 3px;
      background: #00f7ff;
      box-shadow: 0 0 8px #00f7ff;
    }
    
    .back-button {
      background: #444;
      color: #fff;
      padding: 8px 16px;
      margin-bottom: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .loader {
      border: 4px solid #444;
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .skeleton {
  background-color: #333;
  border-radius: 8px;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}
    /* Для анімації появи модалки */
#confirm-modal {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

#confirm-modal.show {
  opacity: 1;
  pointer-events: auto;
}

  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="home" class="section active">
    <h2>🎬 Фільм дня</h2>
   <div id="film-of-the-day" class="film-day-card">
  <div class="image-wrapper" style="position: relative;">
    <img id="film-day-img" src="" alt="Фільм дня">
    <div class="film-title-overlay" id="film-title">Назва фільму</div>
  </div>
  <div class="btn-container">
    <button id="film-day-button" class="watch-btn">🎬 Дивитись</button>
  </div>
</div>



      <div id="home-loading" style="text-align:center; margin-top:30px;">
    <span class="loader"></span>
    <div style="margin-top:8px;">Завантаження...</div>
  </div>

    
    <h3>Жанри</h3>
    <div id="genres" style="display:none; flex-wrap:wrap; gap:10px;"></div>
    

    <h3 style="margin-top:25px">Добірки</h3>
  <div id="collections" style="
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  gap: 16px;
  padding: 10px 0;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
"></div>

    </div>
  

  <div id="categories" class="section">
  <h2>Категорії</h2>
  <button class="back-button" onclick="switchTab('home', document.querySelector('[data-tab=home]'))">⬅️ Назад</button>

<div class="genre-main-wrapper" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
  <button class="genre-main-btn" onclick="openGenreGroup('films')">🎯 За жанром</button>
  <button class="genre-main-btn" onclick="switchTab('categories'); openGenreGroup('series')">📺 Серіали</button>
  <button class="genre-main-btn" onclick="openGenreGroup('cartoons')">👧 Мультики</button>
</div>



  

   <!-- 🔽 Підкатегорії: За жанром -->
<div id="group-films" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  <button class="genre-btn" data-genre="Екшн(бойовики)">🔫 Екшн</button>
  <button class="genre-btn" data-genre="Комедії">😂 Комедії</button>
  <button class="genre-btn" data-genre="Детектив">🕵️ Детектив</button>
  <button class="genre-btn" data-genre="Драми">🎭 Драми</button>
  <button class="genre-btn" data-genre="Військові">🪖 Військові</button>
  <button class="genre-btn" data-genre="Фантастика">👽 Фантастика</button>
  <button class="genre-btn" data-genre="Документальний">📚 Документальний</button>
  <button class="genre-btn" data-genre="Трилери">😱 Трилери</button>
  <button class="genre-btn" data-genre="Сімейні">👨‍👩‍👧 Сімейні</button>
  <button class="genre-btn" data-genre="Мелодрами">💔 Мелодрами</button>
  <button class="genre-btn" data-genre="Кримінал">🚔 Кримінал</button>
  <button class="genre-btn" data-genre="Фентезі">🧝 Фентезі</button>
  <button class="genre-btn" data-genre="Пригоди">🌍 Пригоди</button>
  <button class="genre-btn" data-genre="Історичні">🏰 Історичні</button>
  <button class="genre-btn" data-genre="Романтичні">💘 Романтичні</button>
  <button class="genre-btn" data-genre="Жахи">👻 Жахи</button>
</div>

<!-- 🔽 Підкатегорії: Серіали -->
<div id="group-series" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  <button class="genre-btn" data-genre="Українські">🇺🇦 Українські</button>
  <button class="genre-btn" data-genre="Детективні">🕵️‍♀️ Детективні</button>
  <button class="genre-btn" data-genre="Драматичні">🎭 Драматичні</button>
  <button class="genre-btn" data-genre="Пригодницькі">🌄 Пригодницькі</button>
  <button class="genre-btn" data-genre="Комедійні">😂 Комедійні</button>
  <button class="genre-btn" data-genre="Мелодраматичні ">💔 Мелодраматичні </button>
  <button class="genre-btn" data-genre="Історичні серіали">🏰 Історичні серіали</button>
  <button class="genre-btn" data-genre="Фантастичні">👽 Фантастичні</button>
  <button class="genre-btn" data-genre="Кримінальні">🚔 Кримінальні</button>
</div>

<!-- 🔽 Підкатегорії: Мультики -->
<div id="group-cartoons" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  <button class="genre-btn" data-genre="Мультфільми">🎬 Мультфільми</button>
  <button class="genre-btn" data-genre="Мультсеріали">📺 Мультсеріали</button>
</div>

   <!-- 🔍 Фільтр за країною та роком -->
<details id="filter-details" style="margin-top: 20px; margin-bottom: 20px; background: #1c1c1c; border-radius: 10px; padding: 10px 15px;">
  <summary style="font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 10px; color: #00f7ff;">🔎 Фільтри</summary>
  <div style="padding-top: 10px;">
    <h4 style="margin: 10px 0 5px; color: #ccc;">🌍 Країна</h4>
    <div id="country-filters" style="
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      max-height: 100px;
      overflow-y: auto;
    "></div>

    <h4 style="margin: 10px 0 5px; color: #ccc;">📅 Рік</h4>
    <div id="year-filters" style="
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-height: 100px;
      overflow-y: auto;
    "></div>
  </div>
</details>

  </div>

  <div id="genre-results"></div>
</div>


  <div id="favorites" class="section">
  <h2>Улюблене</h2>
  <button class="back-button" onclick="switchTab('account', document.querySelector('[data-tab=account]'))">⬅️ Назад</button>
  <div id="fav-list" class="film-list" style="display: none;"></div>
</div>


  <div id="search" class="section">
    <h2>Пошук</h2>
    <button class="back-button" onclick="switchTab('home', document.querySelector('[data-tab=home]'))">⬅️ Назад</button>
    <input type="text" id="searchInput" placeholder="Введіть назву або жанр..." style="width:100%;padding:10px;">
    <div id="searchResults" style="margin-top: 20px;"></div>
  </div>
<!-- ✅ Секція Акаунт -->
<section id="account" class="section">
  <h2>👤 Акаунт</h2>

  <button id="lucky-button" class="account-button">🎲 Мені пощастить</button>


<hr style="margin: 20px 0; border-color: #444;">

<button class="account-button" onclick="toggleHistory()">🎞 Історія переглядів</button>
<div id="history-wrapper" style="margin-top: 10px;">
  <div id="history-list" class="film-list" style="display: none;"></div>
</div>

<button class="account-button" onclick="clearHistory()">🧹 Очистити історію</button>

<h3 onclick="toggleFact()" style="cursor:pointer; display:flex; align-items:center; gap:10px;">
  🎬 Цікавий факт про кіно
  <span id="fact-arrow">⬇️</span>
</h3>
<div id="fact-box" style="display:none; margin-bottom:15px; background:#1a1a1a; padding:12px 16px; border-left:4px solid #00f7ff; border-radius:8px; color:#ccc;">
  <div id="fact-text">Завантаження...</div>
  <button onclick="loadFacts()" style="margin-top:10px; padding:6px 12px; border:none; background:#00f7ff; color:#000; border-radius:6px; cursor:pointer;">🔁 Інший факт</button>
</div>




<div style="margin: 20px 0;">
  <label for="theme-toggle" style="font-weight: bold;">🌙 Темна тема</label>
  <input type="checkbox" id="theme-toggle" />
</div>


  <h3>🤝 Підтримати проєкт</h3>
  <div style="margin: 20px 0; text-align: center;">
    <a href="https://send.monobank.ua/jar/2FdmSYjoGo" target="_blank" class="btn-donate">☕ На каву адміну</a>
</div>
</section>

  <div class="nav">
    <button class="nav-btn" data-tab="account">👤<span>Акаунт</span></button>
    <button class="nav-btn active" data-tab="home">🏠<span>Головна</span></button>
    <button class="nav-btn" data-tab="categories">🎞️<span>Категорії</span></button>
    <button class="nav-btn" data-tab="favorites">💛<span>Улюблене</span></button>
    <button class="nav-btn" data-tab="search">🔍<span>Пошук</span></button>
  </div>

  <div id="loading-indicator" style="display: none;">
  <div class="loader"></div>
  <div>Завантаження фільму...</div>
</div>

  <script>
    let films = [];

  async function loadFilms() {
  const cachedFilms = localStorage.getItem('films');

  if (cachedFilms) {
    films = JSON.parse(cachedFilms);
    console.log('Фільми завантажені з кешу');
    showFilmOfTheDay();
    showCollections();
    showGenres();
    showCountryFilters();
    showYearFilters();
    fetchAndUpdateFilms(); // фонове оновлення
    return;
  }

  await fetchAndUpdateFilms();
}

async function fetchAndUpdateFilms() {
  try {
    document.getElementById('home-loading').style.display = 'block';

    const res = await fetch('https://opensheet.vercel.app/1LlkMITwr1sXyQI_jmfhrhEPXB2L22MCh8GIXNm5aoTQ/Sheet1');
    films = await res.json();

    localStorage.setItem('films', JSON.stringify(films));
    showFilmOfTheDay();
    showCollections();
    showGenres();
    showCountryFilters();
    showYearFilters();
  } catch (error) {
    console.error('Помилка завантаження фільмів:', error);
  } finally {
    document.getElementById('home-loading').style.display = 'none';
  }
}





let pendingLink = "";

async function openVideo(filmName) {
  const tg = window.Telegram.WebApp;

  if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user || !tg.initDataUnsafe.user.id) {
    alert("❗️Не вдалося отримати ваш Telegram ID. Спробуйте ще раз.");
    return;
  }

  const user = tg.initDataUnsafe.user;
  document.getElementById("loading-indicator").style.display = "block";

  // ⛔ Заблокуємо всі кнопки "Дивитись" на 3 секунди
  document.querySelectorAll('.watch-button').forEach(btn => btn.disabled = true);
  setTimeout(() => {
    document.querySelectorAll('.watch-button').forEach(btn => btn.disabled = false);
  }, 3000);

  // ⏳ Затримка 2 секунди перед запитом
  setTimeout(async () => {
    try {
      const response = await fetch('https://kinobot-qm9q.onrender.com/send-film', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: user.id,
          film_name: filmName
        })
      });

      const data = await response.json();
      console.log("🎬 Відповідь сервера:", data);

      if (data.success) {
        showRedirectButton();
      } else {
        alert(`❗️ Помилка: ${data.error || 'Невідома помилка'}`);
      }
    } catch (error) {
      console.error('❗️ Помилка при запиті:', error);
      alert("❗️ Сталася помилка при надсиланні фільму");
    } finally {
      document.getElementById("loading-indicator").style.display = "none";
    }
  }, 2000);
}

    
function showRedirectButton() {
  const videoWrapper = document.getElementById('video-wrapper');
  videoWrapper.innerHTML = ''; // очищаємо вікно перед показом нового контенту

  const message = document.createElement('div');
  message.textContent = "✅ Фільм надіслано успішно!";
  message.style.marginTop = "10px";
  message.style.color = "#00f7ff";
  message.style.fontSize = "18px";
  message.style.fontWeight = "bold";

  const buttonsWrapper = document.createElement('div');
  buttonsWrapper.style.display = 'flex';
  buttonsWrapper.style.gap = '15px';
  buttonsWrapper.style.marginTop = '20px';
  buttonsWrapper.style.justifyContent = 'center';
  buttonsWrapper.style.flexWrap = 'wrap';

  // Кнопка "Перейти до бота"
  const confirmButton = document.createElement('button');
  confirmButton.className = "watch-btn";
  confirmButton.textContent = "🎬 Перейти до фільма";
  confirmButton.style.padding = "10px 20px";
  confirmButton.style.borderRadius = "10px";
  confirmButton.style.background = "#00f7ff";
  confirmButton.style.color = "#000";
  confirmButton.style.fontWeight = "bold";
  confirmButton.style.cursor = "pointer";
  confirmButton.style.boxShadow = "0 0 10px #00f7ff";
  confirmButton.onclick = () => {
    window.Telegram.WebApp.close();
  };

  // Кнопка "Ні, залишитись тут"
  const cancelButton = document.createElement('button');
  cancelButton.className = "watch-btn";
  cancelButton.textContent = "❌ Залишитись тут";
  cancelButton.style.padding = "10px 20px";
  cancelButton.style.borderRadius = "10px";
  cancelButton.style.background = "#444";
  cancelButton.style.color = "#fff";
  cancelButton.style.fontWeight = "bold";
  cancelButton.style.cursor = "pointer";
  cancelButton.onclick = () => {
    const overlay = document.getElementById('video-overlay');
    overlay.style.opacity = '0';
    setTimeout(() => {
      overlay.style.display = 'none';
    }, 300);
  };

  buttonsWrapper.appendChild(confirmButton);
  buttonsWrapper.appendChild(cancelButton);

  videoWrapper.appendChild(message);
  videoWrapper.appendChild(buttonsWrapper);

  const overlay = document.getElementById('video-overlay');
  overlay.style.display = 'flex';
  setTimeout(() => {
    overlay.style.opacity = '1';
  }, 50);
}



function confirmOpen() {
  const modal = document.getElementById('confirm-modal');
  modal.classList.remove('show');
  setTimeout(() => {
    try {
      if (window.Telegram?.WebApp?.openLink) {
        window.Telegram.WebApp.openLink(pendingLink);
      } else {
        window.open(pendingLink, '_blank');
      }
    } catch (e) {
      console.error('Помилка при відкритті лінку:', e);
      window.open(pendingLink, '_blank');
    } finally {
      pendingLink = "";
    }
  }, 200); // ← Ось ця кома і правильне закриття
}

function cancelOpen() {
  const modal = document.getElementById('confirm-modal');
  modal.classList.remove('show');
  pendingLink = "";
}





function closeVideo() {
  const videoOverlay = document.getElementById('video-overlay');
  const videoWrapper = document.getElementById('video-wrapper');

  videoWrapper.innerHTML = ''; // очищаємо відео
  videoOverlay.style.opacity = '0';
  setTimeout(() => {
    videoOverlay.style.display = 'none';
    switchTab('home', document.querySelector('[data-tab=home]'));
  }, 400);
}





function showFilmOfTheDay() {
  document.getElementById('film-day-img').classList.remove('skeleton');
  document.getElementById('film-day-img').style.background = 'none';

  const film = films[Math.floor(Math.random() * films.length)];
  document.getElementById('film-day-img').src = film['Фото'];

  document.getElementById('film-day-button').onclick = () => {
    const videoUrl = film['Посилання']; // ⬅️ тут тепер 'Посилання'
    openVideo(film['Назва']); // ⬅️ відкриваємо
  };

  document.getElementById('film-title').textContent = film['Назва'];
}


    function showSkeletonFilmOfTheDay() {
  document.getElementById('film-day-img').style.background = '#333';
  document.getElementById('film-day-img').classList.add('skeleton');
  document.getElementById('film-title').textContent = '';
}




    function showGenres() {
  const genres = ['Новинки', 'Комедії', 'Драми', 'Серіали', 'Мультфільми'];
  document.getElementById('genres').innerHTML = genres.map(g => {
    if (g === 'Мультфільми') {
      return `<button class="genre-btn" onclick="goToCartoons()">👧 ${g}</button>`;
    }
    return `<button class="genre-btn" onclick="filterByGenre('${g}')">${g}</button>`;
  }).join('');
  document.getElementById('genres').style.display = 'flex';
}

    
    function showCountryFilters() {
  const countries = [...new Set(films.map(f => f['Країна']).filter(Boolean))];
  const container = document.getElementById('country-filters');
  container.innerHTML = countries.map(country => `
    <button class="genre-btn" onclick="filterByCountry('${country}')">${country}</button>
  `).join('');
  container.style.display = 'flex';
}

function showYearFilters() {
  const years = [...new Set(films.map(f => f['Рік']).filter(Boolean))];
  const container = document.getElementById('year-filters');
  container.innerHTML = years.map(year => `
    <button class="genre-btn" onclick="filterByYear('${year}')">${year}</button>
  `).join('');
  container.style.display = 'flex';
}

    

    function showCollections() {
  const container = document.getElementById('collections');
  const names = [...new Set(films.map(f => f['Добірка']).filter(Boolean))];
  container.innerHTML = names.map(name => {
    const img = films.find(f => f['Добірка'] === name)?.['Фото'] || '';
    return `
      <div class="collection-card" onclick="filterByGenre('${name}')">
        <img src="${img}" alt="${name}">
        <p>${name}</p>
      </div>
    `;
  }).join('');
  document.getElementById('collections').style.display = 'flex';
}

function showSeries(type = 'Серіал') {
  const container = document.getElementById('genre-results');
  container.innerHTML = '';

  const seriesFilms = films.filter(f => f['Тип'] === type);

  if (seriesFilms.length === 0) {
    container.innerHTML = '<p>Немає серій 😢</p>';
    return;
  }



  // Групуємо серії за назвою серіалу
  const grouped = {};
  seriesFilms.forEach(f => {
    if (!grouped[f['Назва']]) {
      grouped[f['Назва']] = [];
    }
    grouped[f['Назва']].push(f);
  });

  container.innerHTML = Object.keys(grouped).map(title => `
  <div class="series-card">
    <div class="series-header" onclick="toggleSeries('${title}')">
      <span class="series-icon">📺</span>
      <span class="series-title">${title}</span>
    </div>
    <div id="series-${title}" style="display:none; padding-left:15px; margin-top:8px;">
      ${grouped[title].map(episode => `
        <div style="margin-bottom:8px;">
          ▶️ <button class="search-button" onclick="openVideo('${episode['Посилання']}')">${episode['Опис'] || 'Серія'} </button>
        </div>
      `).join('')}
    </div>
  </div>
`).join('');


  container.scrollIntoView({ behavior: 'smooth' });
}

    function toggleSeries(title) {
  const block = document.getElementById(`series-${title}`);
  if (block) {
    block.style.display = (block.style.display === 'none') ? 'block' : 'none';
  }
}

  function filterByGenre(genre) {
  switchTab('categories');
  const container = document.getElementById('genre-results');

  let filtered = films.filter(f =>
  f['Жанр']?.toLowerCase() === genre.toLowerCase() || 
  f['Добірка']?.toLowerCase() === genre.toLowerCase()
);


  if (filtered.length === 0) {
    container.innerHTML = '<p>Нічого не знайдено 😢</p>';
    return;
  }

  // 🔵 Перевіряємо: якщо є серіали
  const hasSeries = filtered.some(f => f['Тип'] === 'Серіал');

  if (hasSeries) {
    // 🔥 Групуємо серіали
    const grouped = {};
    filtered.forEach(f => {
      if (!grouped[f['Назва']]) {
        grouped[f['Назва']] = [];
      }
      grouped[f['Назва']].push(f);
    });

    container.innerHTML = Object.keys(grouped).map(title => `
      <div class="series-card">
        <div class="series-header" onclick="toggleSeries('${title}')">
          <span class="series-icon">📺</span>
          <span class="series-title">${title}</span>
        </div>
        <div id="series-${title}" style="display:none; padding-left:15px; margin-top:8px;">
          ${grouped[title].map(episode => `
            <div style="margin-bottom:8px;">
              ▶️ <button class="search-button" onclick="openVideo('${episode['Назва']}')">${episode['Опис'] || 'Серія'}</button>
            </div>
          `).join('')}
        </div>
      </div>
    `).join('');

  } else {
    // 🟡 Звичайні фільми
    container.innerHTML = filtered.map(film => `
      <div class="film-card">
        <img src="${film['Фото']}" alt="${film['Назва']}">
        <h3>${film['Назва']}</h3>
        <p class="film-desc">${film['Опис']}</p>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          ${film['Посилання'] ? `<button class="search-button" onclick="event.stopPropagation(); openVideo('${film['Назва']}')">▶️ Дивитись</button>` : ''}
          <button class="fav-button" onclick="event.stopPropagation(); addToFavorites('${film['Назва']}', '${film['Опис']}')">💛 Улюблене</button>
        </div>
      </div>
    `).join('');
  }

  container.scrollIntoView({ behavior: 'smooth' });
}



    function filterByCountry(country) {
  switchTab('categories');
  const container = document.getElementById('genre-results');

  const filtered = films.filter(f => f['Країна'] === country);

  if (filtered.length === 0) {
    container.innerHTML = '<p>Нічого не знайдено 😢</p>';
    return;
  }

  container.innerHTML = filtered.map(film => `
    <div class="film-card">
      <img src="${film['Фото']}" alt="${film['Назва']}">
      <h3>${film['Назва']}</h3>
      <p>${film['Опис']}</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        ${film['Посилання'] ? `<button class="search-button" onclick="event.stopPropagation(); openVideo('${film['Назва']}')">▶️ Дивитись</button>` : ''}
        <button class="fav-button" onclick="event.stopPropagation(); addToFavorites('${film['Назва']}', '${film['Опис']}')">💛 Улюблене</button>
      </div>
    </div>
  `).join('');

  container.scrollIntoView({ behavior: 'smooth' });
}


  

function filterByYear(year) {
  switchTab('categories');
  const container = document.getElementById('genre-results');

  const filtered = films.filter(f => f['Рік']?.toString() === year.toString());

  if (filtered.length === 0) {
    container.innerHTML = '<p>Нічого не знайдено 😢</p>';
    return;
  }

  container.innerHTML = filtered.map(film => `
    <div class="film-card">
      <img src="${film['Фото']}" alt="${film['Назва']}">
      <h3>${film['Назва']}</h3>
      <p>${film['Опис']}</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        ${film['Посилання'] ? `<button class="search-button" onclick="event.stopPropagation(); openVideo('${film['Назва']}')">▶️ Дивитись</button>` : ''}
        <button class="fav-button" onclick="event.stopPropagation(); addToFavorites('${film['Назва']}', '${film['Опис']}')">💛 Улюблене</button>
      </div>
    </div>
  `).join('');
}



   function showFavorites() {
  document.querySelectorAll('.film-card').forEach(el => el.remove());

  const container = document.getElementById('fav-list');
  container.innerHTML = '';

  const favs = JSON.parse(localStorage.getItem('favorites') || '[]');

  if (favs.length === 0) {
    container.innerHTML = '<p>Немає улюблених</p>';
  } else {
    container.innerHTML = favs.map(f => `
      <div class="film-card">
        <h3>${f.title}</h3>
        <p>${f.description}</p>
        <button class="remove-fav-btn" onclick="removeFromFavorites(${favs.indexOf(f)})">🗑️ Видалити</button>
        <!-- Додаємо кнопку для перегляду відео -->
        <button class="search-button" onclick="event.stopPropagation(); openVideo('${f.title}')">▶️ Дивитись</button>
      </div>
    `).join('');
  }

  container.style.display = 'block';
}





    

  
// ⬇️ Сюди вставляєш нову функцію
function removeFromFavorites(index) {
  const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
  favs.splice(index, 1);
  localStorage.setItem('favorites', JSON.stringify(favs));
  showFavorites(); // оновити список
}



    function searchInBot(query) {
      // 🧹 Повне очищення залишків
document.getElementById('history-list').innerHTML = '';
document.getElementById('searchResults').innerHTML = '';
document.querySelectorAll('.film-card').forEach(card => card.remove());

  // ❗️Спочатку ховаємо всі секції (прибирає візуальний "перекіс")
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  // ✅ Повертаємось на головну
  document.getElementById('home').classList.add('active');
  document.querySelector('[data-tab=home]')?.classList.add('active');

  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;
  if (!user) return alert("❗️Не вдалося отримати Telegram ID");

  document.getElementById("loading-indicator").style.display = "block";

  // Очищаємо пошук
  document.getElementById('searchInput').value = '';
  document.getElementById('searchResults').innerHTML = '';

  fetch('https://kinobot-qm9q.onrender.com/search-in-bot', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: user.id, query })
  }).then(r => r.json()).then(d => {
    if (d.found && d.videoUrl) {
      const existing = JSON.parse(localStorage.getItem('history') || '[]');
      if (!existing.find(f => f.title === query)) {
        const film = films.find(f => f['Назва'] === query);
        if (film) {
          existing.unshift({ title: film['Назва'], description: film['Опис'] });
          if (existing.length > 20) existing.pop();
          localStorage.setItem('history', JSON.stringify(existing));
        }
      }
      window.location.href = d.videoUrl;
    } else {
      alert("Фільм не знайдено 😢");
    }
  }).catch(console.error).finally(() => {
    document.getElementById("loading-indicator").style.display = "none";
  });
}


    
    function openGenreGroup(group) {
  // ❌ Приховати ВСІ підкатегорії
  document.getElementById("group-films").style.display = "none";
  document.getElementById("group-series").style.display = "none";
  document.getElementById("group-cartoons").style.display = "none";

  // ❌ Очистити вивід результатів пошуку фільмів
  const container = document.getElementById('genre-results');
  if (container) {
    container.innerHTML = '';
  }

  // ✅ Показати тільки потрібну групу
  const block = document.getElementById("group-" + group);
  if (block) block.style.display = "flex";
}


  function switchTab(tabId, btn) {
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  // 🧹 Очищаємо всі основні контейнери
  const containersToClear = [
    'genre-results',
    'searchResults',
    'fav-list'
  ];
  containersToClear.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = '';
  });

  // Прибираємо розгорнуті картки
  document.querySelectorAll('.film-card.expanded').forEach(el => el.classList.remove('expanded'));

  const target = document.getElementById(tabId);
  if (target) target.classList.add('active');
  if (btn) btn.classList.add('active');

  if (tabId === 'favorites') showFavorites();
  if (tabId === 'account') window.scrollTo({ top: 0, behavior: 'smooth' });
}


function showSkeletonCollections() {
  const container = document.getElementById('collections');
  container.innerHTML = `
    <div class="film-card skeleton" style="height:200px; width:130px; border-radius:12px;"></div>
    <div class="film-card skeleton" style="height:200px; width:130px; border-radius:12px;"></div>
    <div class="film-card skeleton" style="height:200px; width:130px; border-radius:12px;"></div>
  `;
}


  document.addEventListener('DOMContentLoaded', async () => {
    // Прокидаємо бекенд Render, щоб не спав
  try {
    await fetch('https://kinobot-qm9q.onrender.com/ping');
    console.log('✅ Бекенд прокинувся');
  } catch (e) {
    console.warn('⚠️ Бекенд не прокинувся:', e);
  }

  fetch('https://kinobot-qm9q.onrender.com/ping').catch(console.warn);
  Telegram.WebApp.ready();
  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;

  if (!user) {
    alert("Не вдалося отримати ваш Telegram ID");
    return;
  }

  try {
    const res = await fetch('https://kinobot-qm9q.onrender.com/check-subscription', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: user.id })
    });

    const data = await res.json();

   if (!data.subscribed) {
  document.body.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #00f7ff;
      text-align: center;
      padding: 20px;
      font-family: 'Russo One', sans-serif;
    ">
      <h1 style="font-size: 28px; margin-bottom: 20px;">❗ Щоб користуватись застосунком</h1>
      <h2 style="font-size: 22px; margin-bottom: 40px;">Підпишіться на канал 🎥</h2>

      <a href="https://t.me/KinoTochkaUA" target="_blank" style="
        background: #00f7ff;
        color: #000;
        padding: 15px 30px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: bold;
        text-decoration: none;
        box-shadow: 0 0 15px #00f7ff;
        transition: all 0.3s ease;
      " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 0 25px #00f7ff';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 0 15px #00f7ff';">
        📢 ПІДПИСАТИСЬ
      </a>

      <p style="margin-top: 40px; font-size: 16px; color: #ccc;">Після підписки оновіть застосунок 📲</p>
    </div>
  `;
  return;
}

  } catch (error) {
    console.error('Помилка перевірки підписки', error);
    alert("❗ Помилка перевірки підписки");
    return;
  }

  // 🟢 Якщо підписаний, тільки тоді все інше:
  

  // Очищення кешу раз на добу
  const lastClear = localStorage.getItem('lastClear');
  const now = Date.now();
  if (!lastClear || now - lastClear > 1000 * 60 * 60 * 24) {
    localStorage.removeItem('films');
    localStorage.setItem('lastClear', now);
  }

  // Показати скелетони
  showSkeletonCollections();
  showSkeletonFilmOfTheDay();

  // Завантажити фільми і факти
  loadFilms();
  loadFacts();

  // Показати фільтри країн і років
  showCountryFilters();
  showYearFilters();

  // Темна тема
  const toggle = document.getElementById('theme-toggle');
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'light') {
    document.body.classList.add('light-theme');
    toggle.checked = true;
  }
  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.body.classList.add('light-theme');
      localStorage.setItem('theme', 'light');
    } else {
      document.body.classList.remove('light-theme');
      localStorage.setItem('theme', 'dark');
    }
  });

  // Кнопка прокрутки догори
  const scrollTopBtn = document.getElementById('scrollTopBtn');
  if (scrollTopBtn) {
    scrollTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
        scrollTopBtn.classList.add('show');
      } else {
        scrollTopBtn.classList.remove('show');
      }
    });
  }

  // Обробники кнопок навігації
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.getAttribute('data-tab');
      switchTab(tab, btn);
    });
  });

  // Обробники жанрів
  document.querySelectorAll('.genre-btn').forEach(button => {
    button.addEventListener('click', () => {
      const genre = button.getAttribute('data-genre');
      filterByGenre(genre);
    });
  });

  // Пошук
  document.getElementById('searchInput').addEventListener('input', () => {
    const val = document.getElementById('searchInput').value.toLowerCase();
    const results = [];
    const seenTitles = new Set();

    films.forEach(f => {
      const title = f['Назва'].toLowerCase();
      if (title.includes(val) && !seenTitles.has(title)) {
        results.push(f);
        seenTitles.add(title);
        }
      });
    
    if (results.length === 0) {
      document.getElementById('searchResults').innerHTML = `
        <p>Фільм не знайдено 😢</p>
        <button class="suggest-button" onclick="suggestFilm()">➕ Замовити фільм для додавання</button>
      `;
    } else {
      document.getElementById('searchResults').innerHTML = results.map(f => `
  <div class="film-card fade-in">
    <img src="${f['Фото']}" alt="${f['Назва']}">
    <h3>${f['Назва']}</h3>
    <p class="film-desc">${f['Опис']}</p>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      ${f['Посилання'] ? `<button class="search-button" onclick="event.stopPropagation(); openVideo('${f['Назва']}')">▶️ Дивитись</button>` : ''}
      <button class="fav-button" onclick="event.stopPropagation(); addToFavorites('${f['Назва']}', '${f['Опис']}', '${f['Назва']}')">💛 Улюблене</button>

    </div>
  </div>
`).join('');

    }
  });

  // Клік по картці
  document.addEventListener('click', (e) => {
    const card = e.target.closest('.film-card');
    if (card && !e.target.closest('button')) {
      card.classList.toggle('expanded');
    }
  });

});



  function addToFavorites(title, description, videoUrl) {
  const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
  
  if (favs.find(f => f.title === title)) {
    alert('Вже в улюбленому 💛');
    return;
  }

  // Зберігаємо фільм з URL
  favs.push({ title, description, videoUrl });

  // Зберігаємо оновлений список у LocalStorage
  localStorage.setItem('favorites', JSON.stringify(favs));

  // Оновлюємо список "Улюблених"
  showFavorites(); 

  // Показуємо повідомлення
  alert('Додано в улюблене!');
}


  

document.getElementById("lucky-button").addEventListener("click", () => {
  if (!films.length) {
    alert("⏳ Фільми ще не завантажились");
    return;
  }

  const randomFilm = films[Math.floor(Math.random() * films.length)];
  alert(`🎬 ${randomFilm['Назва']}\n\n${randomFilm['Опис'] || ''}`);
});

     let isSending = false;

function suggestFilm() {
  const val = document.getElementById('searchInput').value.trim();
  if (!val) {
    alert("Спочатку введіть назву фільму!");
    return;
  }

  if (isSending) {
    alert("⏳ Запит вже надсилається...");
    return;
  }

  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;

  if (!user) {
    alert("❗️Не вдалося отримати ваш Telegram ID");
    return;
  }

  isSending = true;
  const btn = document.querySelector(".suggest-button");
if (btn) {
  btn.disabled = true;
  setTimeout(() => btn.disabled = false, 3000);
}


  fetch('https://kinobot-qm9q.onrender.com/request-film', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: user.id, film_name: val })
  })
  .then(async res => {
    const contentType = res.headers.get("content-type");
    if (contentType && contentType.includes("application/json")) {
      const data = await res.json();
      alert('✅ Запит на додавання фільму надіслано!');
    } else {
      const text = await res.text();
      console.warn("⚠️ Не JSON відповідь:", text.slice(0, 100));
      alert("⚠️ Сервер повернув неочікувану відповідь. Спробуйте пізніше.");
    }
  })
  .catch((error) => {
    console.error(error);
    alert('❗️ Сталася помилка при надсиланні запиту.');
  })
  .finally(() => {
    isSending = false;
  });
}


    async function loadFacts() {
  try {
    const res = await fetch("https://opensheet.vercel.app/1K4RYcbUqoA96E2ZkXgkj0836x3H5aleHpz9YDql3Yik/Sheet1");
    const facts = await res.json();
    const randomFact = facts[Math.floor(Math.random() * facts.length)];
    document.getElementById('fact-text').innerText = `🎬 ${randomFact['Факт']}`;
  } catch (error) {
    document.getElementById('fact-box').innerText = '⚠️ Не вдалося завантажити факт.';
  }
}

    function toggleHistory() {
  const container = document.getElementById('history-list');
  if (container.style.display === 'block') {
    container.style.display = 'none';
  } else {
    showHistory();
  }
}



// ✅ ВИНЕСИ окремо функцію rate() після showHistory
function rate(title, stars) {
  localStorage.setItem(`rating_${title}`, stars);
  showHistory();
}


function clearHistory() {
  localStorage.removeItem('history');
  showHistory(); // одразу оновлює вивід
}
      
 function toggleFact() {
  const box = document.getElementById('fact-box');
  const arrow = document.getElementById('fact-arrow');
  const isVisible = box.style.display === 'block';
  box.style.display = isVisible ? 'none' : 'block';
  arrow.textContent = isVisible ? '⬇️' : '⬆️';
}

   function goToCartoons() {
  switchTab('categories', document.querySelector('[data-tab=categories]'));
  openGenreGroup('cartoons');

  // Додаємо плавну прокрутку через 300 мс, коли все відкриється
  setTimeout(() => {
    const target = document.getElementById('group-cartoons');
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, 300);
}


    
</script>

<button id="scrollTopBtn" class="scroll-top-btn">🔝</button>

<div id="video-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; justify-content:center; align-items:center; transition: opacity 0.4s ease;">
  <div id="video-wrapper" style="background:#000; padding:20px; border-radius:12px; max-width:800px; width:90%; text-align:center; box-shadow: 0 0 20px rgba(0, 247, 255, 0.3);">
    <!-- Тут JS вставлятиме або loader, або відео через innerHTML -->
  </div>
</div>

<div id="confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#1a1a1a; padding:20px; border-radius:12px; max-width:300px; text-align:center; box-shadow:0 0 20px #00f7ff;">
    <p style="color:#00f7ff; font-size:18px; margin-bottom:20px;">🎬 Бажаєте відкрити фільм?</p>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button onclick="confirmOpen()" style="padding:8px 16px; background:#00f7ff; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Так</button>
      <button onclick="cancelOpen()" style="padding:8px 16px; background:#444; border:none; border-radius:8px; cursor:pointer; color:#fff;">Ні</button>
    </div>
  </div>
</div>



</body>
</html>
