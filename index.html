<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KinoBot Web App</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #111;
      color: #fff;
    }
    .section {
      display: none;
      padding: 20px;
    }
    .active {
      display: block;
    }
    .nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #222;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      border-top: 1px solid #333;
    }
    .nav button {
      background: none;
      border: none;
      color: #aaa;
      font-size: 16px;
      cursor: pointer;
    }
    .nav button.active {
      color: #fff;
      font-weight: bold;
    }
  </style>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

</head>
<body>

    <div id="home" class="section active" style="padding: 20px;">
  <h2 style="margin-bottom: 10px;">🎬 Фільм дня</h2>
<div id="film-of-the-day" class="film-day-card">
  <img id="film-img" src="" alt="" />
  <div class="film-title-overlay" id="film-title">Назва</div>
  <a id="film-link" href="#" target="_blank" class="film-day-button">▶️ Дивитись</a>
</div>




  <div style="margin: 25px 0 10px;">
    <h3>Жанри</h3>
    <div style="display:flex; flex-wrap:wrap; gap:10px; padding:10px 0;">
      <button class="genre-btn" data-genre="Новинки">Новинки</button>
      <button class="genre-btn" data-genre="Комедії">Комедії</button>
      <button class="genre-btn" data-genre="Драми">Драми</button>
      <button class="genre-btn" data-genre="Серіали">Серіали</button>
      <button class="genre-btn" data-genre="Мультфільми">Мультфільми</button>
    </div>
</div>

  <div>
    <h3>Добірки</h3>
    <div style="display:flex; overflow-x:auto; gap:10px; padding:10px 0;">
      <div style="min-width:120px; background:#222; padding:10px; border-radius:10px;">
        <img src="https://i.postimg.cc/XY1GbWNR/cry.jpg" style="width:100%; border-radius:8px;">
        <p style="margin-top:5px; font-size:14px;">10 сліз під подушку</p>
      </div>
      <div style="min-width:120px; background:#222; padding:10px; border-radius:10px;">
        <img src="https://i.postimg.cc/L6DGMgMz/daddy.jpg" style="width:100%; border-radius:8px;">
        <p style="margin-top:5px; font-size:14px;">Батько і дитина</p>
      </div>
      <div style="min-width:120px; background:#222; padding:10px; border-radius:10px;">
        <img src="https://i.postimg.cc/TYwF0mXB/ukr.jpg" style="width:100%; border-radius:8px;">
        <p style="margin-top:5px; font-size:14px;">Тільки українською</p>
      </div>
    </div>
  </div>
</div>

      

 <!-- 🎞️ Категорії -->
<div id="categories" class="section">
  <h2>Категорії</h2>

  <div class="genre-main-wrapper">
    <div id="genre-main-buttons" class="genre-main-buttons">
      <button class="genre-main-btn fade-in" data-group="films">🎯 За жанром</button>
      <button class="genre-main-btn fade-in" data-group="series">📺 Серіали</button>
      <button class="genre-main-btn fade-in" data-group="cartoons">👧 Мультики</button>

    </div>
  </div>
  
<!-- 🔽 Підкатегорії: За жанром -->
<div id="group-films" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  <button class="genre-btn" data-genre="Екшн(бойовики)">🔫 Екшн</button>
  <button class="genre-btn" data-genre="Комедії">😂 Комедії</button>
  <button class="genre-btn" data-genre="Детективи">🕵️ Детективи</button>
  <button class="genre-btn" data-genre="Драми">🎭 Драми</button>
  <button class="genre-btn" data-genre="Військові">🪖 Військові</button>
  <button class="genre-btn" data-genre="Фантастика">👽 Фантастика</button>
  <button class="genre-btn" data-genre="Документальні">📚 Документальні</button>
  <button class="genre-btn" data-genre="Трилери">😱 Трилери</button>
  <button class="genre-btn" data-genre="Сімейні">👨‍👩‍👧 Сімейні</button>
  <button class="genre-btn" data-genre="Мелодрами">💔 Мелодрами</button>
  <button class="genre-btn" data-genre="Кримінал">🚔 Кримінал</button>
  <button class="genre-btn" data-genre="Фентезі">🧝 Фентезі</button>
  <button class="genre-btn" data-genre="Пригоди">🌍 Пригоди</button>
  <button class="genre-btn" data-genre="Історичні">🏰 Історичні</button>
  <button class="genre-btn" data-genre="Романтичні">💘 Романтичні</button>
  <button class="genre-btn" data-genre="Жахи">👻 Жахи</button>
</div>

<!-- 🔽 Підкатегорії: Серіали -->
<div id="group-series" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  <button class="genre-btn" data-genre="Українські">🇺🇦 Українські</button>
  <button class="genre-btn" data-genre="Детективні">🕵️‍♀️ Детективні</button>
  <button class="genre-btn" data-genre="Драматичні">🎭 Драматичні</button>
  <button class="genre-btn" data-genre="Пригодницькі">🌄 Пригодницькі</button>
  <button class="genre-btn" data-genre="Комедійні">😂 Комедійні</button>
  <button class="genre-btn" data-genre="Мелодрами">💔 Мелодрами</button>
  <button class="genre-btn" data-genre="Історичні">🏰 Історичні</button>
  <button class="genre-btn" data-genre="Фантастичні">👽 Фантастичні</button>
  <button class="genre-btn" data-genre="Кримінальні">🚔 Кримінальні</button>
</div>

<!-- 🔽 Підкатегорії: Мультики -->
<div id="group-cartoons" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  
</div>

  <div id="genre-results" style="margin-top:20px;"></div>
</div>



  <!-- ❤️ Улюблене -->
  <div id="favorites" class="section">
    <h2>Улюблене</h2>
    <p>Список збережених фільмів...</p>
  </div>

  <!-- 🔍 Пошук -->
  <div id="search" class="section">
    <h2>Пошук</h2>
    <input
      type="text"
      id="searchInput"
      placeholder="Введіть назву або жанр..."
      style="width:100%;padding:10px;"
      oninput="searchFilms()"
    />
    <div id="searchResults" style="margin-top: 20px;"></div>
  </div>
  

  <!-- Меню навігації -->
  <div class="nav">
  <button class="nav-btn active" data-tab="home">Головна</button>
  <button class="nav-btn" data-tab="categories">Категорії</button>
  <button class="nav-btn" data-tab="favorites">Улюблене</button>
  <button class="nav-btn" data-tab="search">Пошук</button>
</div>

  <script>
 
    let films = [];
  
    async function loadFilms() {
      const res = await fetch('https://opensheet.vercel.app/1LlkMITwr1sXyQI_jmfhrhEPXB2L22MCh8GIXNm5aoTQ/Sheet1');
      films = await res.json();
      showFilmOfTheDay();
    }

    function switchTab(tabId, btn) {
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');

  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  btn.classList.add('active');

  if (tabId === 'favorites') {
    showFavorites();
  }
}

    window.addEventListener('DOMContentLoaded', () => {
  window.Telegram.WebApp.ready();
  loadFilms();
        // Привʼязка жанрів у "Фільм дня"
  document.querySelectorAll('.genre-btn').forEach(btn => {
    const genre = btn.dataset.genre;
    if (genre) {
      btn.addEventListener('click', () => {
        // Переключити на вкладку "Категорії"
        switchTab('categories', document.querySelector('[data-tab="categories"]'));
        // Викликати фільтрацію
        filterByGenre(genre);
      });
    }
  });


  // ✅ Прив’язка кнопок "За жанром", "Серіали", "Мультики"
  document.querySelectorAll('.genre-main-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const group = btn.dataset.group;

    // Зняти клас active з усіх
    document.querySelectorAll('.genre-main-btn').forEach(b => b.classList.remove('active'));

    // Додати активний клас до натиснутої
    btn.classList.add('active');

    // Показати відповідну групу
    openGenreGroup(group);
  });
});


  // ✅ Прив’язка підкатегорій до фільтра
  document.querySelectorAll('.genre-btn').forEach(btn => {
    const genre = btn.dataset.genre;
    if (genre) {
      btn.addEventListener('click', () => {
        filterByGenre(genre);
      });
    }
  });

  // ✅ Прив’язка кнопок нижнього меню
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tabId = btn.dataset.tab;
      switchTab(tabId, btn);
    });
  });

});


    function addToFavorites(title, description) {
      const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      favorites.push({ title, description });
      localStorage.setItem('favorites', JSON.stringify(favorites));
      alert('Додано в улюблене 💛');
    }
  
    function showFavorites() {
      const container = document.getElementById('favorites');
      const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
  
      let html = '<h2>Улюблене</h2>';
      if (favorites.length === 0) {
        html += '<p>Нічого не збережено 😢</p>';
      } else {
        favorites.forEach(item => {
          html += `
            <div style="background:#1c1c1c; padding:10px; margin-bottom:10px; border-radius:8px;">
              <h3>${item.title}</h3>
              <p>${item.description}</p>
            </div>
          `;
        });
      }
      container.innerHTML = html;
    }

    function filterByGenre(genre) {
  const container = document.getElementById('genre-results');
  container.innerHTML = `<h3 style="margin-top:10px;">🎬 ${genre}</h3>`;

  let filtered;

  if (genre === 'Новинки') {
    // Беремо останні 10 фільмів
    filtered = films.slice(-10).reverse(); // останні, у зворотному порядку
  } else {
    filtered = films.filter(film =>
      film['Жанр']?.toLowerCase().includes(genre.toLowerCase())
    );
  }

  if (filtered.length === 0) {
    container.innerHTML += `<p>Нічого не знайдено 😢</p>`;
    return;
  }

  container.innerHTML += filtered.map(film => `
    <div style="
      background: linear-gradient(145deg, #1c1c1c, #2c2c2c);
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    ">
      <img src="${film['Фото']}" alt="${film['Назва']}" style="width:100%; border-radius:10px; margin-bottom:15px;">
      <h3 style="margin-bottom:5px;">${film['Назва']}</h3>
      <p style="opacity:0.85;">${film['Опис']}</p>
      <button class="search-button" data-query="${film['Назва'].replace(/'/g, "\\'")}"
        style="margin-top:12px; background:#e50914; color:#fff; padding:10px 20px; border-radius:8px; border:none; cursor:pointer; font-weight:bold;">
        ▶️ Пошукати в боті
      </button>
    </div>
  `).join('');

  container.querySelectorAll('.search-button').forEach(button => {
    button.addEventListener('click', () => {
      const query = button.getAttribute('data-query');
      searchInBot(query);
    });
  });
}


  
   function searchFilms() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const results = films.filter(film =>
    film['Назва'].toLowerCase().includes(query) ||
    film['Жанр'].toLowerCase().includes(query) ||
    film['Опис'].toLowerCase().includes(query)
  );

  const container = document.getElementById('searchResults');
  if (results.length === 0) {
    container.innerHTML = '<p>Нічого не знайдено 😢</p>';
    return;
  }

  container.innerHTML = results.map(film => `
    <div style="background:#1c1c1c; padding:10px; margin-bottom:20px; border-radius:10px;">
      <img src="${film['Фото']}" alt="${film['Назва']}" style="max-width:100%; height:auto; border-radius:10px; margin-bottom:10px;">
      <h3>${film['Назва']}</h3>
      <p>${film['Опис']}</p>
      <button class="search-button" data-query="${film['Назва'].replace(/'/g, "\\'")}"
        style="display:inline-block; background:#e50914; color:#fff; padding:10px 20px; border-radius:5px; border:none; cursor:pointer; margin-top:10px;">
        ▶️ Пошукати в боті
      </button>
    </div>
  `).join('');

  // ⬇️ обовʼязково після вставки кнопок
  container.querySelectorAll('.search-button').forEach(button => {
    button.addEventListener('click', () => {
  const query = button.getAttribute('data-query');
  searchInBot(query);

});


  });
}


      // Ховати клавіатуру при натисканні на будь-що, крім input
  document.addEventListener('click', (e) => {
    if (e.target.tagName !== 'INPUT') {
      const active = document.activeElement;
      if (active && typeof active.blur === 'function') {
        active.blur();
      }
    }
  });

  // Ховати клавіатуру при Enter у полі пошуку
  document.getElementById('searchInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      e.target.blur();
    }
  });
async function searchInBot(query) {
  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;

  if (!user) {
    alert("❗️Не вдалося отримати Telegram ID");
    return;
  }

  const user_id = user.id;
  const backendUrl = "https://kinobot-qm9q.onrender.com/search-in-bot";

  console.log("📤 Надсилаємо запит:", { user_id, query });

  const res = await fetch(backendUrl, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ user_id, query })
  });

  const data = await res.json();
  console.log("📥 Відповідь від сервера:", data);

  if (data.found && data.videoUrl) {
    window.location.href = data.videoUrl;

  } else {
    alert("Фільм не знайдено 😢");
  }
}

  function openGenreGroup(group) {
  // Сховати всі групи
  document.getElementById("group-films").style.display = "none";
  document.getElementById("group-series").style.display = "none";
  const cartoonsGroup = document.getElementById("group-cartoons");
if (cartoonsGroup) {
  cartoonsGroup.style.display = "none";
}


  // Показати активну
  document.getElementById(`group-${group}`).style.display = "flex";
}

    function showFilmOfTheDay() {
  const container = document.getElementById("film-of-the-day");
  if (!films.length) return;

  const todayKey = new Date().toDateString();
  const stored = JSON.parse(localStorage.getItem("filmOfTheDay"));

  let film;
  if (stored && stored.date === todayKey) {
    film = stored.film;
  } else {
    film = films[Math.floor(Math.random() * films.length)];
    localStorage.setItem("filmOfTheDay", JSON.stringify({ date: todayKey, film }));
  }

  container.innerHTML = `
    <img src="${film['Фото']}" alt="${film['Назва']}">
    <div class="film-day-overlay">
      <h3 style="margin:0 0 4px;">${film['Назва']}</h3>
      <p style="margin:0; font-size:14px; opacity:0.85;">${film['Опис']}</p>
    </div>
    <a href="${film['Посилання']}" target="_blank">
      <button class="film-day-button">▶️ Дивитись</button>
    </a>
  `;
}



</script>
  
  
</body>
</html>
