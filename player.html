<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé¨ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—É</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      text-align: center;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: background-color 0.6s ease; /* üü¢ –ø–ª–∞–≤–Ω–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—è */
    }

    h2 {
      margin: 16px 0;
      font-weight: 500;
      color: #00e0ff;
    }

    video {
      width: 100%;
      height: calc(100vh - 80px);
      background: #000;
      border: none;
      outline: none;
      object-fit: contain;
    }

    .loading {
      color: #aaa;
      font-size: 16px;
      margin-top: 15px;
    }

    .error {
      color: #ff4444;
      font-size: 18px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h2 id="filmTitle">üéûÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ...</h2>
  <video id="videoPlayer" controls muted autoplay playsinline></video>
  <p class="loading" id="statusText">‚è≥ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è...</p>

  <script>
    const backendUrl = "https://relax-time2.onrender.com"; // ‚Üê –±–µ–∫–µ–Ω–¥ Render
    const WORKER_URL = "https://kino-proxy.lyuda14070702.workers.dev"; // ‚Üê Cloudflare Worker

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const filmId = params.get("id");

      const titleEl = document.getElementById("filmTitle");
      const statusEl = document.getElementById("statusText");
      const video = document.getElementById("videoPlayer");
      // üíæ –ó–ê–ü–ê–ú'–Ø–¢–û–í–£–í–ê–ù–ù–Ø –ü–û–ó–ò–¶–Ü–á –í–Ü–î–¢–í–û–†–ï–ù–ù–Ø
      const posKey = "lastPosition_" + filmId;
      
      // –ö–æ–∂–Ω—ñ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å –≤—ñ–¥–µ–æ
      video.addEventListener("timeupdate", () => {
        try {
          localStorage.setItem(posKey, video.currentTime);
        } catch (e) {
          console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é:", e);
        }
      });
      
      // –ö–æ–ª–∏ –≤—ñ–¥–µ–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ‚Äî –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é
      video.addEventListener("loadedmetadata", () => {
        const pos = parseFloat(localStorage.getItem(posKey) || "0");
        if (pos > 3) { // —è–∫—â–æ –±—ñ–ª—å—à–µ 3 —Å–µ–∫—É–Ω–¥ ‚Äî –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ
          video.currentTime = pos;
        }
      });

      if (!filmId) {
        titleEl.textContent = "‚ùå ID —Ñ—ñ–ª—å–º—É –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ";
        statusEl.textContent = "";
        return;
      }

      try {
        // üîπ –û—Ç—Ä–∏–º—É—î–º–æ stream_url —ñ–∑ –±–µ–∫–µ–Ω–¥—É (—á–µ—Ä–µ–∑ service_role)
        const res = await fetch(`${backendUrl}/stream/${filmId}`);
        const data = await res.json();

        if (!data || data.error || !data.stream_url) {
          titleEl.textContent = "‚ùå –§—ñ–ª—å–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
          statusEl.textContent = "";
          console.error("–í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞:", data);
          return;
        }

        const stream = data.stream_url;
        titleEl.textContent = "üé¨ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—É";
        statusEl.textContent = "üîó –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ø–æ—Ç–æ–∫—É...";

        // üîπ –§–æ—Ä–º—É—î–º–æ –∑–∞—Ö–∏—â–µ–Ω–∏–π URL —á–µ—Ä–µ–∑ Cloudflare Worker
        const finalUrl = `${WORKER_URL}/m3u8?src=${btoa(stream)}`;

        // üîπ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–µ—Ä–µ–∑ HLS.js
        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(finalUrl);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            statusEl.textContent = "";
            video.play();
          });
          hls.on(Hls.Events.ERROR, (event, data) => {
            // –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É –ª–∏—à–µ —è–∫—â–æ –ø–æ—Ç—ñ–∫ —Å–ø—Ä–∞–≤–¥—ñ –∑—É–ø–∏–Ω–∏–≤—Å—è
            if (data.fatal) {
              console.error("HLS fatal error:", data);
              statusEl.textContent = "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Ç–æ–∫—É";
            } else {
              console.warn("HLS warning:", data.details);
            }
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = finalUrl;
          video.addEventListener("loadedmetadata", () => {
            statusEl.textContent = "";
            video.play();
          });
        } else {
          titleEl.textContent = "‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î HLS";
          statusEl.textContent = "";
        }
      } catch (err) {
        console.error(err);
        titleEl.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ";
        statusEl.textContent = "";
      }
    });

  // üé¨ –†–µ–∂–∏–º –∫—ñ–Ω–æ (–∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—è —Ñ–æ–Ω—É –ø—Ä–∏ Picture-in-Picture –∞–±–æ Fullscreen)
video.addEventListener("enterpictureinpicture", () => {
  document.body.style.background = "#000";
});
video.addEventListener("leavepictureinpicture", () => {
  document.body.style.background = "#000";
});
video.addEventListener("fullscreenchange", () => {
  if (document.fullscreenElement) {
    document.body.style.background = "#000";
  } else {
    document.body.style.background = "#000";
  }
});
// üéß –í–º–∏–∫–∞—î–º–æ –∑–≤—É–∫ –ø—Ä–∏ –ø–µ—Ä—à—ñ–π –≤–∑–∞—î–º–æ–¥—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
document.addEventListener("click", () => {
  const video = document.getElementById("videoPlayer");
  if (video.muted) {
    video.muted = false;
    video.volume = 1.0;
    console.log("üîä –ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ");
  }
}, { once: true });

  </script>
</body>
</html>
