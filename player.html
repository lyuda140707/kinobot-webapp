<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé¨ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—É</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      text-align: center;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: background-color 0.6s ease; /* üü¢ –ø–ª–∞–≤–Ω–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—è */
    }

    h2 {
      margin: 16px 0;
      font-weight: 500;
      color: #00e0ff;
    }

    video {
      width: 100%;
      height: calc(100vh - 80px);
      background: #000;
      border: none;
      outline: none;
      object-fit: contain;
    }
    
    #filmTitle, #statusText, #closeBtn, #castButton, #airplayButton {
      transition: opacity 0.4s ease;
      position: relative;
      z-index: 15;
    }

    .loading {
      color: #aaa;
      font-size: 16px;
      margin-top: 15px;
    }

    .error {
      color: #ff4444;
      font-size: 18px;
      margin-top: 20px;
    }
    .cast-btn, .airplay-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 8px 14px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(90deg, #00e0ff, #00bcd4);
      color: #000;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 224, 255, 0.6);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      z-index: 10;
    }
    .cast-btn:hover, .airplay-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(0, 224, 255, 0.8);
    }
  #closeBtn:hover {
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(0,224,255,0.8);
  }
  </style>

<!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Cast API -->
<script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

</head>

<body>
  <h2 id="filmTitle">üéûÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ...</h2>
  <video id="videoPlayer" controls muted autoplay playsinline></video>
  <!-- –ö–Ω–æ–ø–∫–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó -->
  <button id="castButton" class="cast-btn" style="display:none;">üì∫ –ü–µ—Ä–µ–¥–∞—Ç–∏ –Ω–∞ –¢–í</button>
  <button id="airplayButton" class="airplay-btn" style="display:none;">üçè AirPlay</button>
  <!-- ‚ùå –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è -->
  <button id="closeBtn"
    style="position:absolute; top:12px; left:12px;
           background:rgba(0,0,0,0.6); color:#fff;
           border:none; border-radius:50%;
           width:38px; height:38px; font-size:20px;
           cursor:pointer; z-index:20;
           box-shadow:0 0 10px rgba(0,224,255,0.6);
           transition:transform 0.2s ease, box-shadow 0.2s ease;">
    ‚úñ
  </button>

  <!-- üîä –ö–Ω–æ–ø–∫–∞ –¥–ª—è —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è –∑–≤—É–∫—É -->
  <button id="unmuteBtn"
          style="position:absolute; top:35%;; left:50%; transform:translate(-50%, -50%);
                 background:rgba(0,224,255,0.9); color:#000; font-weight:600;
                 padding:12px 20px; border:none; border-radius:10px; cursor:pointer;
                 font-size:16px; display:none; z-index:5; transition:opacity 0.4s ease;">
    üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫
  </button>
  <p class="loading" id="statusText">‚è≥ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è...</p>
  

  <script>
    const backendUrl = "https://relax-time2.onrender.com"; // ‚Üê –±–µ–∫–µ–Ω–¥ Render
    const WORKER_URL = "https://kino-proxy.lyuda14070702.workers.dev"; // ‚Üê Cloudflare Worker
    const tg = window.Telegram?.WebApp;

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const filmId = params.get("id");

      const titleEl = document.getElementById("filmTitle");
      const statusEl = document.getElementById("statusText");
      const video = document.getElementById("videoPlayer");
      // üíæ –ó–ê–ü–ê–ú'–Ø–¢–û–í–£–í–ê–ù–ù–Ø –ü–û–ó–ò–¶–Ü–á –í–Ü–î–¢–í–û–†–ï–ù–ù–Ø
      const posKey = "lastPosition_" + filmId;
      
      // –ö–æ–∂–Ω—ñ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å –≤—ñ–¥–µ–æ
      video.addEventListener("timeupdate", () => {
        try {
          localStorage.setItem(posKey, video.currentTime);
        } catch (e) {
          console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é:", e);
        }
      });
      
      // –ö–æ–ª–∏ –≤—ñ–¥–µ–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ‚Äî –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é
      video.addEventListener("loadedmetadata", () => {
        const pos = parseFloat(localStorage.getItem(posKey) || "0");
        if (pos > 3) { // —è–∫—â–æ –±—ñ–ª—å—à–µ 3 —Å–µ–∫—É–Ω–¥ ‚Äî –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ
          video.currentTime = pos;
        }
      });

      if (!filmId) {
        titleEl.textContent = "‚ùå ID —Ñ—ñ–ª—å–º—É –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ";
        statusEl.textContent = "";
        return;
      }

      try {
        // üîπ –û—Ç—Ä–∏–º—É—î–º–æ stream_url —ñ–∑ –±–µ–∫–µ–Ω–¥—É (—á–µ—Ä–µ–∑ service_role)
        const res = await fetch(`${backendUrl}/stream/${filmId}`);
        const data = await res.json();

        if (!data || data.error || !data.stream_url) {
          titleEl.textContent = "‚ùå –§—ñ–ª—å–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
          statusEl.textContent = "";
          console.error("–í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞:", data);
          return;
        }

        const stream = data.stream_url;
        titleEl.textContent = "üé¨ " + (data.title || data.name || "–§—ñ–ª—å–º");
        statusEl.textContent = "üîó –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ø–æ—Ç–æ–∫—É...";

        // üîπ –§–æ—Ä–º—É—î–º–æ –∑–∞—Ö–∏—â–µ–Ω–∏–π URL —á–µ—Ä–µ–∑ Cloudflare Worker
        const finalUrl = `${WORKER_URL}/m3u8?src=${btoa(stream)}`;

        // üîπ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–µ—Ä–µ–∑ HLS.js
        if (Hls.isSupported()) {
          const hls = new Hls({
            lowLatencyMode: true,
            enableWorker: true,
            fragLoadingTimeOut: 20000,   // –º–∞–∫—Å–∏–º—É–º 20 —Å–µ–∫. –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
            maxBufferLength: 10,         // –Ω–µ–≤–µ–ª–∏–∫–∏–π –±—É—Ñ–µ—Ä –¥–ª—è —à–≤–∏–¥–∫–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó
            startLevel: -1,              // –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä —è–∫–æ—Å—Ç—ñ
            maxMaxBufferLength: 30
          });
          hls.loadSource(finalUrl);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            statusEl.textContent = "";
            video.play();
          });
          hls.on(Hls.Events.ERROR, (event, data) => {
            // –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É –ª–∏—à–µ —è–∫—â–æ –ø–æ—Ç—ñ–∫ —Å–ø—Ä–∞–≤–¥—ñ –∑—É–ø–∏–Ω–∏–≤—Å—è
            if (data.fatal) {
              console.error("HLS fatal error:", data);
              statusEl.textContent = "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Ç–æ–∫—É";
            } else {
              console.warn("HLS warning:", data.details);
            }
          });
          // üê¢ –ê–≤—Ç–æ-–∑–Ω–∏–∂–µ–Ω–Ω—è —è–∫–æ—Å—Ç—ñ –ø—Ä–∏ –ø–æ–≤—ñ–ª—å–Ω–æ–º—É –ø–æ—Ç–æ—Ü—ñ
          hls.on(Hls.Events.FRAG_LOAD_ERROR, () => {
            console.warn("üê¢ –ü–æ—Ç—ñ–∫ –ø–æ–≤—ñ–ª—å–Ω–∏–π ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞—é –Ω–∞ –Ω–∏–∂—á—É —è–∫—ñ—Å—Ç—å");
            const level = Math.max(0, hls.currentLevel - 1);
            hls.currentLevel = level;
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = finalUrl;
          video.addEventListener("loadedmetadata", () => {
            statusEl.textContent = "";
            video.play();
          });
        } else {
          titleEl.textContent = "‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î HLS";
          statusEl.textContent = "";
        }
      } catch (err) {
        console.error(err);
        titleEl.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ";
        statusEl.textContent = "";
      }
// üéß –ö–Ω–æ–ø–∫–∞ "–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫"
const unmuteBtn = document.getElementById("unmuteBtn");
setTimeout(() => { if (video.muted) unmuteBtn.style.display = "block"; }, 1000);
unmuteBtn.addEventListener("click", () => {
  video.muted = false;
  video.volume = 1.0;
  video.play().catch(()=>{});
  unmuteBtn.style.opacity = "0";
  setTimeout(() => (unmuteBtn.style.display = "none"), 400);
});
// ‚ùå –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è (Telegram –∞–±–æ –±—Ä–∞—É–∑–µ—Ä)
const closeBtn = document.getElementById("closeBtn");
closeBtn.addEventListener("click", () => {
  try {
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.close(); // –ó–∞–∫—Ä–∏—Ç–∏ Telegram WebApp
    } else {
      // –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏—Ç–æ —É –±—Ä–∞—É–∑–µ—Ä—ñ ‚Äî —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–∞–∫—Ä–∏—Ç–∏ –≤–∫–ª–∞–¥–∫—É
      window.history.back();
      setTimeout(() => window.close(), 300);
    }
  } catch {
    window.close();
  }
});

// üé• –ö–ª—ñ–∫ –ø–æ –≤—ñ–¥–µ–æ ‚Üí —Ö–æ–≤–∞—î –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —ñ –≤–º–∏–∫–∞—î –ø–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω
const videoEl = document.getElementById("videoPlayer");
let isUiHidden = false;

videoEl.addEventListener("click", () => {
  if (!document.fullscreenElement) {
    videoEl.requestFullscreen().catch(err => console.warn("Fullscreen error:", err));
  } else {
    document.exitFullscreen();
  }

  // –•–æ–≤–∞—î–º–æ / –ø–æ–∫–∞–∑—É—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏
  isUiHidden = !isUiHidden;
  ["filmTitle", "statusText", "castButton", "airplayButton", "closeBtn"].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.opacity = isUiHidden ? "0" : "1";
      el.style.pointerEvents = isUiHidden ? "none" : "auto";
    }
  });
});
// üî∏ –ö–ª—ñ–∫ –±—É–¥—å-–¥–µ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ ‚Äî —Ç–µ–∂ —Ö–æ–≤–∞—î –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏, –∑–∞–ª–∏—à–∞—é—á–∏ –ª–∏—à–µ –≤—ñ–¥–µ–æ
document.body.addEventListener("click", (e) => {
  // –Ø–∫—â–æ –∫–ª—ñ–∫ –Ω–µ –ø–æ —Å–∞–º–æ–º—É –≤—ñ–¥–µ–æ ‚Äî —Ç–æ–¥—ñ —Ö–æ–≤–∞—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  if (e.target.id !== "videoPlayer") {
    if (!document.fullscreenElement) {
      videoEl.requestFullscreen().catch(err => console.warn("Fullscreen error:", err));
    }
    isUiHidden = true;
    ["filmTitle", "statusText", "castButton", "airplayButton", "closeBtn"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.style.opacity = "0";
        el.style.pointerEvents = "none";
      }
    });
  }
});

});

  // üé¨ –†–µ–∂–∏–º –∫—ñ–Ω–æ (–∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—è —Ñ–æ–Ω—É –ø—Ä–∏ Picture-in-Picture –∞–±–æ Fullscreen)
video.addEventListener("enterpictureinpicture", () => {
  document.body.style.background = "#000";
});
video.addEventListener("leavepictureinpicture", () => {
  document.body.style.background = "#000";
});
video.addEventListener("fullscreenchange", () => {
  if (document.fullscreenElement) {
    document.body.style.background = "#000";
  } else {
    document.body.style.background = "#000";
  }
});
// === –ü–Ü–î–¢–†–ò–ú–ö–ê CAST (ANDROID / CHROME) ===
window.__onGCastApiAvailable = function(isAvailable) {
  if (isAvailable) {
    const context = cast.framework.CastContext.getInstance();
    context.setOptions({
      receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
      autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
    });
    document.getElementById('castButton').style.display = 'block';
  }
};

// üì∫ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–µ–æ –Ω–∞ –¢–í
async function castToTV() {
  const video = document.getElementById("videoPlayer");
  const castSession = cast.framework.CastContext.getInstance().getCurrentSession();
  if (castSession && video.src) {
    const mediaInfo = new chrome.cast.media.MediaInfo(video.src, 'application/x-mpegURL');
    const request = new chrome.cast.media.LoadRequest(mediaInfo);
    try {
      await castSession.loadMedia(request);
      console.log("üì∫ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞ –¢–í —Ä–æ–∑–ø–æ—á–∞—Ç–æ");
    } catch (err) {
      console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ Cast:", err);
    }
  } else {
    alert("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ Chromecast –ø–æ–±–ª–∏–∑—É");
  }
}
document.getElementById('castButton').addEventListener('click', castToTV);

// === –ü–Ü–î–¢–†–ò–ú–ö–ê AIRPLAY (IPHONE / SAFARI) ===
const airplayBtn = document.getElementById("airplayButton");
if (window.WebKitPlaybackTargetAvailabilityEvent) {
  airplayBtn.style.display = 'block';
  airplayBtn.addEventListener('click', () => {
    if (video.webkitShowPlaybackTargetPicker) {
      video.webkitShowPlaybackTargetPicker();
    }
  });
}

    



  </script>
</body>
</html>
