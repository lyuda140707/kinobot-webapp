<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé¨ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—É</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      text-align: center;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    h2 {
      margin: 16px 0;
      font-weight: 500;
      color: #00e0ff;
    }

    video {
      width: 100%;
      height: 100%;
      background-color: #000;
      outline: none;
    }

    .loading {
      color: #aaa;
      font-size: 16px;
      margin-top: 15px;
    }

    .error {
      color: #ff4444;
      font-size: 18px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h2 id="filmTitle">üéûÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ...</h2>
  <video id="videoPlayer" controls autoplay></video>
  <p class="loading" id="statusText">‚è≥ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è...</p>

  <script>
    const backendUrl = "https://relax-time2.onrender.com"; // ‚Üê –±–µ–∫–µ–Ω–¥ Render
    const WORKER_URL = "https://kino-proxy.lyuda14070702.workers.dev"; // ‚Üê Cloudflare Worker

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const filmId = params.get("id");

      const titleEl = document.getElementById("filmTitle");
      const statusEl = document.getElementById("statusText");
      const video = document.getElementById("videoPlayer");

      if (!filmId) {
        titleEl.textContent = "‚ùå ID —Ñ—ñ–ª—å–º—É –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ";
        statusEl.textContent = "";
        return;
      }

      try {
        // üîπ –û—Ç—Ä–∏–º—É—î–º–æ stream_url —ñ–∑ –±–µ–∫–µ–Ω–¥—É (—á–µ—Ä–µ–∑ service_role)
        const res = await fetch(`${backendUrl}/stream/${filmId}`);
        const data = await res.json();

        if (!data || data.error || !data.stream_url) {
          titleEl.textContent = "‚ùå –§—ñ–ª—å–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
          statusEl.textContent = "";
          console.error("–í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞:", data);
          return;
        }

        const stream = data.stream_url;
        titleEl.textContent = "üé¨ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—É";
        statusEl.textContent = "üîó –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ø–æ—Ç–æ–∫—É...";

        // üîπ –§–æ—Ä–º—É—î–º–æ –∑–∞—Ö–∏—â–µ–Ω–∏–π URL —á–µ—Ä–µ–∑ Cloudflare Worker
        const encoded = btoa(stream);
        const finalUrl = `${WORKER_URL}/m3u8?src=${encoded}`;

        // üîπ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–µ—Ä–µ–∑ HLS.js
        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(finalUrl);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            statusEl.textContent = "";
            video.play();
          });
          hls.on(Hls.Events.ERROR, (event, data) => {
            console.error("HLS error:", data);
            statusEl.textContent = "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Ç–æ–∫—É";
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = finalUrl;
          video.addEventListener("loadedmetadata", () => {
            statusEl.textContent = "";
            video.play();
          });
        } else {
          titleEl.textContent = "‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î HLS";
          statusEl.textContent = "";
        }
      } catch (err) {
        console.error(err);
        titleEl.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ";
        statusEl.textContent = "";
      }
    });
  </script>
</body>
</html>
