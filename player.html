<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé¨ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—É</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      text-align: center;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: background-color 0.6s ease; /* üü¢ –ø–ª–∞–≤–Ω–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—è */
    }

    h2 {
      margin: 16px 0;
      font-weight: 500;
      color: #00e0ff;
    }

    video {
      width: 100%;
      height: calc(100vh - 80px);
      background: #000;
      border: none;
      outline: none;
      object-fit: contain;
    }

    .loading {
      color: #aaa;
      font-size: 16px;
      margin-top: 15px;
    }

    .error {
      color: #ff4444;
      font-size: 18px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h2 id="filmTitle">üéûÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ...</h2>
  <video id="videoPlayer" controls muted autoplay playsinline></video>
  <!-- üîä –ö–Ω–æ–ø–∫–∞ –¥–ª—è —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è –∑–≤—É–∫—É -->
  <button id="unmuteBtn"
          style="position:absolute; top:35%;; left:50%; transform:translate(-50%, -50%);
                 background:rgba(0,224,255,0.9); color:#000; font-weight:600;
                 padding:12px 20px; border:none; border-radius:10px; cursor:pointer;
                 font-size:16px; display:none; z-index:5; transition:opacity 0.4s ease;">
    üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫
  </button>
  <p class="loading" id="statusText">‚è≥ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è...</p>

  <script>
    const backendUrl = "https://relax-time2.onrender.com"; // ‚Üê –±–µ–∫–µ–Ω–¥ Render
    const WORKER_URL = "https://kino-proxy.lyuda14070702.workers.dev"; // ‚Üê Cloudflare Worker

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const filmId = params.get("id");

      const titleEl = document.getElementById("filmTitle");
      const statusEl = document.getElementById("statusText");
      const video = document.getElementById("videoPlayer");
      // üü¢ Telegram WebView fix ‚Äî —à—Ç—É—á–Ω–∞ –≤–∑–∞—î–º–æ–¥—ñ—è –¥–ª—è –∞–≤—Ç–æ–ø–ª–µ–π
      document.body.addEventListener("touchstart", () => {
        if (video.paused) {
          video.play().catch(()=>{});
        }
      }, { once: true });
      // üíæ –ó–ê–ü–ê–ú'–Ø–¢–û–í–£–í–ê–ù–ù–Ø –ü–û–ó–ò–¶–Ü–á –í–Ü–î–¢–í–û–†–ï–ù–ù–Ø
      const posKey = "lastPosition_" + filmId;
      
      // –ö–æ–∂–Ω—ñ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å –≤—ñ–¥–µ–æ
      video.addEventListener("timeupdate", () => {
        try {
          localStorage.setItem(posKey, video.currentTime);
        } catch (e) {
          console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é:", e);
        }
      });
      
      // –ö–æ–ª–∏ –≤—ñ–¥–µ–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ‚Äî –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é
      video.addEventListener("loadedmetadata", () => {
        const pos = parseFloat(localStorage.getItem(posKey) || "0");
        if (pos > 3) { // —è–∫—â–æ –±—ñ–ª—å—à–µ 3 —Å–µ–∫—É–Ω–¥ ‚Äî –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ
          video.currentTime = pos;
        }
      });

      if (!filmId) {
        titleEl.textContent = "‚ùå ID —Ñ—ñ–ª—å–º—É –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ";
        statusEl.textContent = "";
        return;
      }

      try {
        // üîπ –û—Ç—Ä–∏–º—É—î–º–æ stream_url —ñ–∑ –±–µ–∫–µ–Ω–¥—É (—á–µ—Ä–µ–∑ service_role)
        const res = await fetch(`${backendUrl}/stream/${filmId}`);
        const data = await res.json();

        if (!data || data.error || !data.stream_url) {
          titleEl.textContent = "‚ùå –§—ñ–ª—å–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
          statusEl.textContent = "";
          console.error("–í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞:", data);
          return;
        }

        const stream = data.stream_url;
        titleEl.textContent = "üé¨ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—É";
        statusEl.textContent = "üîó –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ø–æ—Ç–æ–∫—É...";

        // üîπ –§–æ—Ä–º—É—î–º–æ –∑–∞—Ö–∏—â–µ–Ω–∏–π URL —á–µ—Ä–µ–∑ Cloudflare Worker
        const finalUrl = `${WORKER_URL}/m3u8?src=${btoa(stream)}`;

        // üîπ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–µ—Ä–µ–∑ HLS.js
        if (Hls.isSupported()) {
          const hls = new Hls({
            lowLatencyMode: true,
            enableWorker: true,
            fragLoadingTimeOut: 20000,   // –º–∞–∫—Å–∏–º—É–º 20 —Å–µ–∫. –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
            maxBufferLength: 10,         // –Ω–µ–≤–µ–ª–∏–∫–∏–π –±—É—Ñ–µ—Ä –¥–ª—è —à–≤–∏–¥–∫–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó
            startLevel: -1,              // –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä —è–∫–æ—Å—Ç—ñ
            maxMaxBufferLength: 30
          });
          hls.loadSource(finalUrl);
          hls.attachMedia(video);
          video.muted = true; 
          video.play().catch(()=>{}); // üîπ —Ñ–æ—Ä—Å—É—î —Å—Ç–∞—Ä—Ç –±–µ–∑ –≤–∑–∞—î–º–æ–¥—ñ—ó
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            statusEl.textContent = "";
            video.play();
          });
          hls.on(Hls.Events.ERROR, (event, data) => {
            // –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É –ª–∏—à–µ —è–∫—â–æ –ø–æ—Ç—ñ–∫ —Å–ø—Ä–∞–≤–¥—ñ –∑—É–ø–∏–Ω–∏–≤—Å—è
            if (data.fatal) {
              console.error("HLS fatal error:", data);
              statusEl.textContent = "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Ç–æ–∫—É";
            } else {
              console.warn("HLS warning:", data.details);
            }
          });
          // üê¢ –ê–≤—Ç–æ-–∑–Ω–∏–∂–µ–Ω–Ω—è —è–∫–æ—Å—Ç—ñ –ø—Ä–∏ –ø–æ–≤—ñ–ª—å–Ω–æ–º—É –ø–æ—Ç–æ—Ü—ñ
          hls.on(Hls.Events.FRAG_LOAD_ERROR, () => {
            console.warn("üê¢ –ü–æ—Ç—ñ–∫ –ø–æ–≤—ñ–ª—å–Ω–∏–π ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞—é –Ω–∞ –Ω–∏–∂—á—É —è–∫—ñ—Å—Ç—å");
            const level = Math.max(0, hls.currentLevel - 1);
            hls.currentLevel = level;
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = finalUrl;
          video.addEventListener("loadedmetadata", () => {
            statusEl.textContent = "";
            video.play();
          });
        } else {
          titleEl.textContent = "‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î HLS";
          statusEl.textContent = "";
        }
      } catch (err) {
        console.error(err);
        titleEl.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ";
        statusEl.textContent = "";
      }
    // üéß –ö–Ω–æ–ø–∫–∞ "–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫"
    const unmuteBtn = document.getElementById("unmuteBtn");

    // —á–µ—Ä–µ–∑ –Ω–µ–≤–µ–ª–∏–∫—É –ø–∞—É–∑—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ mute —ñ –ø–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É
    setTimeout(() => {
      if (video.muted) {
        unmuteBtn.style.display = "block";
      }
    }, 1000);
    // –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ –∫–Ω–æ–ø—Ü—ñ ‚Äî —É–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫ —ñ —Å—Ö–æ–≤–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
    unmuteBtn.addEventListener("click", () => {
      video.muted = false;
      video.volume = 1.0;
      video.play().catch(()=>{});
      unmuteBtn.style.opacity = "0";
      setTimeout(() => (unmuteBtn.style.display = "none"), 400);
      });
    });

  // üé¨ –†–µ–∂–∏–º –∫—ñ–Ω–æ (–∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—è —Ñ–æ–Ω—É –ø—Ä–∏ Picture-in-Picture –∞–±–æ Fullscreen)
video.addEventListener("enterpictureinpicture", () => {
  document.body.style.background = "#000";
});
video.addEventListener("leavepictureinpicture", () => {
  document.body.style.background = "#000";
});
video.addEventListener("fullscreenchange", () => {
  if (document.fullscreenElement) {
    document.body.style.background = "#000";
  } else {
    document.body.style.background = "#000";
  }
});

  </script>
</body>
</html>
